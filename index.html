<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Common Ground - Music Visualization</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { 
      font-family: 'Inter', -apple-system, sans-serif;
      background: linear-gradient(145deg, #0d0d12 0%, #1a1a2e 40%, #16213e 100%);
      min-height: 100vh;
      overflow: hidden;
      color: #fff;
    }
    
    /* Login Screen */
    #login-screen {
      position: fixed;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: linear-gradient(145deg, #0d0d12 0%, #1a1a2e 40%, #16213e 100%);
      z-index: 10000;
    }
    
    #login-screen.hidden { display: none; }
    
    .login-container {
      text-align: center;
      max-width: 400px;
      padding: 40px;
    }
    
    .login-container h1 {
      font-size: 42px;
      font-weight: 700;
      margin-bottom: 8px;
      letter-spacing: -1px;
    }
    
    .login-container .tagline {
      color: rgba(255,255,255,0.5);
      font-size: 16px;
      margin-bottom: 40px;
    }
    
    .spotify-btn {
      display: inline-flex;
      align-items: center;
      gap: 12px;
      background: #1DB954;
      color: #fff;
      border: none;
      padding: 16px 32px;
      border-radius: 50px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
    }
    
    .spotify-btn:hover { background: #1ed760; transform: scale(1.03); }
    .spotify-btn:active { transform: scale(0.98); }
    
    .spotify-btn svg { width: 24px; height: 24px; }
    
    .login-footer {
      margin-top: 30px;
      font-size: 12px;
      color: rgba(255,255,255,0.3);
    }
    
    /* Loading Screen */
    #loading {
      position: fixed;
      inset: 0;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: linear-gradient(145deg, #0d0d12 0%, #1a1a2e 40%, #16213e 100%);
      z-index: 9999;
    }
    
    #loading.visible { display: flex; }
    
    .loader {
      width: 50px;
      height: 50px;
      border: 3px solid rgba(255,255,255,0.1);
      border-top-color: #1DB954;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 16px;
    }
    
    @keyframes spin { to { transform: rotate(360deg); } }
    
    #loading p { color: rgba(255,255,255,0.6); font-size: 15px; }
    #loading .progress { color: rgba(255,255,255,0.35); font-size: 12px; margin-top: 8px; }
    
    /* App */
    #app {
      width: 100vw;
      height: 100vh;
      position: relative;
      cursor: grab;
      display: none;
    }
    
    #app.ready { display: block; }
    #app.panning { cursor: grabbing; }
    
    .control-panel {
      position: fixed;
      top: 16px;
      left: 16px;
      background: rgba(12,12,20,0.92);
      backdrop-filter: blur(20px);
      border-radius: 16px;
      padding: 18px;
      z-index: 1000;
      border: 1px solid rgba(255,255,255,0.08);
      min-width: 260px;
      max-width: 280px;
      max-height: calc(100vh - 32px);
      overflow-y: auto;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
      cursor: default;
    }
    
    .control-panel h1 { font-size: 20px; font-weight: 700; margin-bottom: 2px; letter-spacing: -0.3px; }
    .control-panel .subtitle { color: rgba(255,255,255,0.45); font-size: 12px; margin-bottom: 14px; }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: rgba(255,255,255,0.04);
      border-radius: 10px;
      margin-bottom: 14px;
    }
    
    .user-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #1DB954;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 14px;
    }
    
    .user-avatar img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
    
    .user-details { flex: 1; min-width: 0; }
    .user-name { font-size: 13px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .user-logout { font-size: 10px; color: rgba(255,255,255,0.4); cursor: pointer; }
    .user-logout:hover { color: #ff6b6b; }
    
    .search-input {
      width: 100%;
      padding: 9px 12px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.1);
      background: rgba(255,255,255,0.04);
      color: #fff;
      font-size: 13px;
      margin-bottom: 10px;
      outline: none;
      font-family: inherit;
    }
    
    .search-input:focus { border-color: rgba(255,255,255,0.2); background: rgba(255,255,255,0.06); }
    .search-results { max-height: 120px; overflow-y: auto; margin-bottom: 14px; }
    
    .search-result {
      padding: 5px 8px;
      font-size: 12px;
      color: rgba(255,255,255,0.8);
      border-radius: 6px;
      background: rgba(255,255,255,0.04);
      margin-bottom: 3px;
      cursor: pointer;
      transition: background 0.15s;
    }
    
    .search-result:hover { background: rgba(255,255,255,0.08); }
    .search-result .artist { color: rgba(255,255,255,0.4); font-size: 11px; }
    
    .section-title { font-size: 11px; color: rgba(255,255,255,0.35); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }
    .zoom-controls { display: flex; gap: 6px; margin-bottom: 5px; }
    
    .zoom-btn {
      flex: 1; padding: 7px; border-radius: 6px; border: none;
      background: rgba(255,255,255,0.08); color: #fff; cursor: pointer;
      font-size: 13px; font-weight: 500; font-family: inherit; transition: background 0.15s;
    }
    
    .zoom-btn:hover { background: rgba(255,255,255,0.12); }
    .zoom-hint { font-size: 10px; color: rgba(255,255,255,0.25); text-align: center; margin-bottom: 14px; }
    .genres-grid { display: flex; flex-wrap: wrap; gap: 3px; margin-bottom: 14px; }
    
    .genre-item {
      display: flex; align-items: center; gap: 5px; padding: 4px 7px;
      border-radius: 8px; cursor: pointer; transition: all 0.15s; border: 1px solid transparent;
    }
    
    .genre-item:hover { background: rgba(255,255,255,0.08); }
    .genre-dot { width: 8px; height: 8px; border-radius: 2px; }
    .genre-name { font-size: 11px; text-transform: capitalize; }
    .genre-count { font-size: 10px; color: rgba(255,255,255,0.35); }
    .playlists-list { max-height: 220px; overflow-y: auto; }
    
    .playlist-item {
      display: flex; align-items: center; gap: 8px; padding: 6px 8px;
      border-radius: 8px; cursor: pointer; transition: all 0.15s;
    }
    
    .playlist-item:hover { background: rgba(255,255,255,0.08); }
    .playlist-dot { width: 8px; height: 8px; border-radius: 2px; flex-shrink: 0; }
    .playlist-info { flex: 1; min-width: 0; }
    .playlist-name { font-size: 12px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .playlist-count { font-size: 10px; color: rgba(255,255,255,0.35); }
    
    #grid-container { position: absolute; left: 50%; top: 50%; transform-origin: center center; will-change: transform; }
    #grid { display: grid; gap: 5px; contain: layout style; }
    
    .song-tile {
      width: 52px; height: 52px; border-radius: 6px; position: relative; overflow: hidden;
      cursor: pointer; transition: transform 0.15s ease, box-shadow 0.15s ease; border: 2px solid transparent;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3); contain: layout style paint;
    }
    
    .song-tile:hover { transform: scale(1.3); z-index: 100; box-shadow: 0 8px 32px rgba(0,0,0,0.5); }
    .song-tile.dimmed { opacity: 0.1; }
    .song-tile.highlighted { box-shadow: 0 0 16px var(--highlight-color); border-color: var(--highlight-color); }
    
    /* Pre-defined highlight colors for playlists */
    .song-tile.hl-0 { --highlight-color: #ff6b6b; }
    .song-tile.hl-1 { --highlight-color: #4ecdc4; }
    .song-tile.hl-2 { --highlight-color: #ffe66d; }
    .song-tile.hl-3 { --highlight-color: #95e1d3; }
    .song-tile.hl-4 { --highlight-color: #dda0dd; }
    .song-tile.hl-5 { --highlight-color: #f7dc6f; }
    .song-tile.hl-6 { --highlight-color: #87ceeb; }
    .song-tile.hl-7 { --highlight-color: #ff9f43; }
    .song-tile.hl-8 { --highlight-color: #a29bfe; }
    .song-tile.hl-9 { --highlight-color: #fd79a8; }
    .song-tile.hl-10 { --highlight-color: #00cec9; }
    .song-tile.hl-11 { --highlight-color: #e17055; }
    .song-tile.hl-12 { --highlight-color: #74b9ff; }
    .song-tile.hl-13 { --highlight-color: #55efc4; }
    .song-tile.hl-14 { --highlight-color: #ffeaa7; }
    .song-tile.hl-15 { --highlight-color: #fab1a0; }
    .song-tile.hl-16 { --highlight-color: #81ecec; }
    .song-tile.hl-17 { --highlight-color: #dfe6e9; }
    
    /* Category highlight colors */
    .song-tile.hl-cat-rb { --highlight-color: #f39c12; }
    .song-tile.hl-cat-hiphop { --highlight-color: #1abc9c; }
    .song-tile.hl-cat-pop { --highlight-color: #ff6b81; }
    .song-tile.hl-cat-rock { --highlight-color: #e74c3c; }
    .song-tile.hl-cat-electronic { --highlight-color: #00d2d3; }
    .song-tile.hl-cat-soul { --highlight-color: #9b59b6; }
    .song-tile.hl-cat-latin { --highlight-color: #fd79a8; }
    .song-tile.hl-cat-indie { --highlight-color: #a29bfe; }
    .song-tile.hl-cat-jazz { --highlight-color: #fdcb6e; }
    .song-tile.hl-cat-country { --highlight-color: #d35400; }
    .song-tile.hl-cat-dancehall { --highlight-color: #00b894; }
    .song-tile.hl-cat-other { --highlight-color: #636e72; }
    
    .song-tile img { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; }
    
    .song-tile .fallback {
      display: flex; align-items: center; justify-content: center;
      width: 100%; height: 100%; font-size: 13px; font-weight: 600; color: rgba(255,255,255,0.85);
    }
    
    .song-tile .category-bar { position: absolute; bottom: 0; left: 0; right: 0; height: 3px; }
    
    .song-tile .popularity-badge {
      position: absolute; top: 2px; right: 2px; background: rgba(0,0,0,0.8);
      border-radius: 8px; padding: 1px 4px; font-size: 9px; font-weight: 600;
    }
    
    .tooltip {
      position: fixed; background: rgba(8,8,16,0.97); border: 1px solid rgba(255,255,255,0.12);
      border-radius: 12px; padding: 12px 16px; z-index: 2000; min-width: 180px; max-width: 260px;
      pointer-events: none; box-shadow: 0 12px 40px rgba(0,0,0,0.5); display: none;
    }
    
    .tooltip.visible { display: block; }
    .tooltip .song-name { font-weight: 600; font-size: 14px; margin-bottom: 3px; }
    .tooltip .artist-name { color: rgba(255,255,255,0.55); font-size: 12px; margin-bottom: 8px; }
    
    .tooltip .category-badge {
      display: inline-block; font-size: 10px; padding: 3px 8px; border-radius: 12px;
      font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;
    }
    
    .tooltip .playlist-tags { display: flex; gap: 4px; flex-wrap: wrap; }
    .tooltip .playlist-tag { font-size: 10px; padding: 3px 7px; border-radius: 10px; font-weight: 500; }
    
    .instructions {
      position: fixed; bottom: 16px; right: 16px; background: rgba(12,12,20,0.85);
      backdrop-filter: blur(10px); border-radius: 10px; padding: 10px 14px;
      border: 1px solid rgba(255,255,255,0.08); font-size: 11px; color: rgba(255,255,255,0.5);
    }
    
    .instructions strong { color: rgba(255,255,255,0.7); }
    
    .taste-profile { margin-bottom: 16px; }
    .taste-score-container { margin-bottom: 10px; }
    .taste-label { font-size: 15px; font-weight: 600; margin-bottom: 6px; text-align: center; }
    .taste-bar-bg { height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden; margin-bottom: 4px; }
    .taste-bar { height: 100%; border-radius: 4px; transition: width 1s ease, background 1s ease; }
    .taste-spectrum { display: flex; justify-content: space-between; font-size: 10px; color: rgba(255,255,255,0.4); }
    .taste-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-top: 10px; }
    .taste-stat { background: rgba(255,255,255,0.04); border-radius: 8px; padding: 8px; text-align: center; }
    .taste-stat-value { font-size: 18px; font-weight: 700; margin-bottom: 2px; }
    .taste-stat-label { font-size: 10px; color: rgba(255,255,255,0.5); text-transform: uppercase; letter-spacing: 0.5px; }
    
    ::-webkit-scrollbar { width: 5px; }
    ::-webkit-scrollbar-track { background: rgba(255,255,255,0.03); }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 3px; }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div id="login-screen">
    <div class="login-container">
      <h1>üéµ Common Ground</h1>
      <p class="tagline">Visualize how your playlists connect</p>
      <button class="spotify-btn" id="login-btn">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"/></svg>
        Login with Spotify
      </button>
      <p class="login-footer">We'll read your playlists to create a visualization.<br>No data is stored on any server.</p>
    </div>
  </div>
  
  <!-- Loading Screen -->
  <div id="loading">
    <div class="loader"></div>
    <p id="loading-text">Connecting to Spotify...</p>
    <p class="progress" id="loading-progress"></p>
  </div>
  
  <!-- Main App -->
  <div id="app">
    <div class="control-panel">
      <h1>üéµ Common Ground</h1>
      <p class="subtitle"><span id="song-count">0</span> songs ‚Ä¢ <span id="playlist-count">0</span> playlists</p>
      
      <div class="user-info" id="user-info">
        <div class="user-avatar" id="user-avatar">?</div>
        <div class="user-details">
          <div class="user-name" id="user-name">Loading...</div>
          <div class="user-logout" id="logout-btn">Logout</div>
        </div>
      </div>
      
      <input type="text" class="search-input" id="search" placeholder="Search songs or artists...">
      <div class="search-results" id="search-results"></div>
      
      <div class="section-title">Zoom: <span id="zoom-level">35</span>%</div>
      <div class="zoom-controls">
        <button class="zoom-btn" onclick="adjustZoom(-0.1)">‚àí</button>
        <button class="zoom-btn" onclick="resetZoom()">Reset</button>
        <button class="zoom-btn" onclick="adjustZoom(0.1)">+</button>
      </div>
      <div class="zoom-hint">Scroll to zoom ‚Ä¢ Drag to pan</div>
      
      <div class="section-title">Your Taste Profile</div>
      <div class="taste-profile" id="taste-profile">
        <div class="taste-score-container">
          <div class="taste-label" id="taste-label">Analyzing...</div>
          <div class="taste-bar-bg">
            <div class="taste-bar" id="taste-bar"></div>
          </div>
          <div class="taste-spectrum">
            <span>Eclectic</span>
            <span>Focused</span>
          </div>
        </div>
        <div class="taste-stats" id="taste-stats"></div>
      </div>
      
      <div class="section-title">Genres</div>
      <div class="genres-grid" id="genres"></div>
      
      <div class="section-title">Playlists</div>
      <div class="playlists-list" id="playlists"></div>
    </div>
    
    <div id="grid-container"><div id="grid"></div></div>
    
    <div class="tooltip" id="tooltip">
      <div class="song-name" id="tooltip-song"></div>
      <div class="artist-name" id="tooltip-artist"></div>
      <div class="category-badge" id="tooltip-category"></div>
      <div class="playlist-tags" id="tooltip-playlists"></div>
    </div>
    
    <div class="instructions">
      <div>üîç <strong>Hover</strong> playlists/genres to highlight</div>
      <div>üìç Most popular songs are in the <strong>center</strong></div>
    </div>
  </div>

  <script>
    // ==================== SPOTIFY AUTH ====================
    const CLIENT_ID = '054e13aa07214d4094f6b01f265ae1fb';
    const REDIRECT_URI = 'https://bnidevs.github.io/common-ground/spotify-callback/';
    const SCOPES = 'playlist-read-private playlist-read-collaborative user-read-private';
    
    // Genre classification by artist name
    const ARTIST_GENRES = {
      'r&b': ['sza','daniel caesar','frank ocean','the weeknd','brent faiyaz','summer walker','jhen√© aiko','h.e.r.','kehlani','6lack','bryson tiller','dvsn','partynextdoor','jacquees','ella mai','ari lennox','lucky daye','giveon','snoh aalegra','victoria mon√©t','chloe x halle','tinashe','teyana taylor','jeremih','trey songz','chris brown','usher','r. kelly','aaliyah','mariah carey','whitney houston','janet jackson','mary j. blige','alicia keys','beyonc√©','rihanna','ciara'],
      'soul': ['erykah badu','lauryn hill','d\'angelo','maxwell','musiq soulchild','jill scott','india.arie','anthony hamilton','raphael saadiq','leon bridges','anderson .paak','tom misch','jacob collier','moonchild','hiatus kaiyote'],
      'hip-hop': ['drake','kendrick lamar','j. cole','travis scott','kanye west','jay-z','nas','future','21 savage','metro boomin','lil uzi vert','playboi carti','lil baby','gunna','young thug','migos','offset','quavo','takeoff','post malone','juice wrld','xxxtentacion','lil peep','trippie redd','roddy ricch','dababy','jack harlow','tyler, the creator','asap rocky','asap ferg','joey bada$$','denzel curry','jid','earthgang','bas','amine','vince staples','mac miller','schoolboy q','ab-soul','isaiah rashad','baby keem','don toliver','sza'],
      'pop': ['taylor swift','ariana grande','dua lipa','billie eilish','olivia rodrigo','doja cat','harry styles','the kid laroi','justin bieber','shawn mendes','charlie puth','ed sheeran','bruno mars','the chainsmokers','marshmello','halsey','bebe rexha','ava max','zara larsson','anne-marie','mabel','rita ora','little mix','fifth harmony','selena gomez','miley cyrus','demi lovato','nick jonas','jonas brothers','one direction','5 seconds of summer','why don\'t we','lauv','jeremy zucker','chelsea cutler','alec benjamin','conan gray','gracie abrams','phoebe bridgers','clairo'],
      'rock': ['arctic monkeys','tame impala','the strokes','red hot chili peppers','foo fighters','nirvana','pearl jam','green day','blink-182','fall out boy','panic! at the disco','twenty one pilots','imagine dragons','onerepublic','coldplay','u2','radiohead','the 1975','glass animals','cage the elephant','the black keys','queens of the stone age','muse','the killers'],
      'electronic': ['flume','disclosure','kaytranada','jamie xx','four tet','floating points','bicep','ross from friends','mall grab','lo-fi house','fred again','skrillex','diplo','major lazer','calvin harris','david guetta','kygo','avicii','zedd','illenium','odesza','rufus du sol','lane 8','above & beyond','deadmau5','eric prydz','carl cox','fisher','chris lake','dom dolla'],
      'latin': ['bad bunny','j balvin','daddy yankee','ozuna','anuel aa','farruko','nicky jam','maluma','rauw alejandro','jhay cortez','myke towers','sech','lunay','tainy','karol g','becky g','rosal√≠a','anitta','shakira'],
      'indie': ['mac demarco','steve lacy','rex orange county','boy pablo','men i trust','khruangbin','mild high club','homeshake','her\'s','peach pit','wallows','dayglow','gus dapperton','benee','beabadoobee','girl in red','mxmtoon','chloe moriondo','remi wolf','role model','dominic fike'],
      'jazz': ['robert glasper','kamasi washington','thundercat','flying lotus','terrace martin','badbadnotgood','snarky puppy','cory henry','jacob collier','louis cole','knower','vulfpeck','fearless flyers','theo croker','christian scott'],
      'country': ['morgan wallen','luke combs','chris stapleton','zach bryan','tyler childers','kacey musgraves','maren morris','kane brown','luke bryan','jason aldean','thomas rhett','florida georgia line','dan + shay'],
      'dancehall': ['popcaan','vybz kartel','alkaline','masicka','skillibeng','spice','shenseea','koffee','protoje','chronixx']
    };
    
    function classifyGenre(artistName) {
      const artist = artistName.toLowerCase();
      for (const [genre, artists] of Object.entries(ARTIST_GENRES)) {
        if (artists.some(a => artist.includes(a) || a.includes(artist))) {
          return genre;
        }
      }
      return 'other';
    }
    
    // PKCE helpers
    function generateRandomString(length) {
      const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      const values = crypto.getRandomValues(new Uint8Array(length));
      return values.reduce((acc, x) => acc + possible[x % possible.length], "");
    }
    
    async function sha256(plain) {
      const encoder = new TextEncoder();
      const data = encoder.encode(plain);
      return window.crypto.subtle.digest('SHA-256', data);
    }
    
    function base64encode(input) {
      return btoa(String.fromCharCode(...new Uint8Array(input)))
        .replace(/=/g, '')
        .replace(/\+/g, '-')
        .replace(/\//g, '_');
    }
    
    async function startAuth() {
      const codeVerifier = generateRandomString(64);
      const hashed = await sha256(codeVerifier);
      const codeChallenge = base64encode(hashed);
      
      localStorage.setItem('code_verifier', codeVerifier);
      
      const params = new URLSearchParams({
        response_type: 'code',
        client_id: CLIENT_ID,
        scope: SCOPES,
        code_challenge_method: 'S256',
        code_challenge: codeChallenge,
        redirect_uri: REDIRECT_URI,
      });
      
      window.location.href = `https://accounts.spotify.com/authorize?${params}`;
    }
    
    async function getToken(code) {
      const codeVerifier = localStorage.getItem('code_verifier');
      
      const response = await fetch('https://accounts.spotify.com/api/token', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({
          client_id: CLIENT_ID,
          grant_type: 'authorization_code',
          code,
          redirect_uri: REDIRECT_URI,
          code_verifier: codeVerifier,
        }),
      });
      
      const data = await response.json();
      if (data.access_token) {
        localStorage.setItem('access_token', data.access_token);
        localStorage.setItem('token_expiry', Date.now() + (data.expires_in * 1000));
      }
      return data.access_token;
    }
    
    async function fetchSpotify(endpoint, token) {
      const response = await fetch(`https://api.spotify.com/v1${endpoint}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      if (!response.ok) throw new Error(`Spotify API error: ${response.status}`);
      return response.json();
    }
    
    async function fetchAllPlaylists(token) {
      const playlists = [];
      let offset = 0;
      let total = 1;
      
      while (offset < total) {
        const data = await fetchSpotify(`/me/playlists?limit=50&offset=${offset}`, token);
        total = data.total;
        playlists.push(...data.items);
        offset += 50;
        updateLoadingProgress(`Fetching playlists... ${playlists.length}/${total}`);
      }
      
      return playlists;
    }
    
    async function fetchPlaylistTracks(playlistId, token) {
      const tracks = [];
      let offset = 0;
      const limit = 100;
      let total = Infinity;
      
      while (offset < total) {
        const data = await fetchSpotify(`/playlists/${playlistId}/tracks?limit=${limit}&offset=${offset}`, token);
        total = data.total;
        
        // Filter valid tracks
        const validItems = data.items.filter(item => item && item.track && item.track.id);
        tracks.push(...validItems);
        
        offset += limit;
      }
      
      return tracks;
    }
    
    async function fetchUserProfile(token) {
      return await fetchSpotify('/me', token);
    }
    
    function updateLoadingProgress(text) {
      document.getElementById('loading-progress').textContent = text;
    }
    
    async function loadSpotifyData(token) {
      document.getElementById('login-screen').classList.add('hidden');
      document.getElementById('loading').classList.add('visible');
      document.getElementById('loading-text').textContent = 'Loading your music...';
      
      try {
        // Fetch user profile
        const user = await fetchUserProfile(token);
        localStorage.setItem('user_name', user.display_name || user.id);
        localStorage.setItem('user_image', user.images?.[0]?.url || '');
        
        // Fetch all playlists
        const playlistsRaw = await fetchAllPlaylists(token);
        
        // Fetch tracks for all playlists in parallel (with concurrency limit)
        const allPlaylistData = [];
        let completed = 0;
        const total = playlistsRaw.length;
        const CONCURRENCY = 6; // Spotify rate limit friendly
        
        // Process playlists in batches - return raw data, merge later
        const processPlaylist = async (p) => {
          try {
            const tracks = await fetchPlaylistTracks(p.id, token);
            const playlistTracks = [];
            
            for (const item of tracks) {
              const track = item.track;
              // Skip null tracks, local files, and episodes
              if (!track || !track.id || track.is_local || track.type === 'episode') continue;
              
              playlistTracks.push({
                id: track.id,
                name: track.name,
                artist: track.artists?.[0]?.name || 'Unknown',
                img: track.album?.images?.[1]?.url || track.album?.images?.[0]?.url || '',
              });
            }
            
            if (playlistTracks.length > 0) {
              return { id: p.id, name: p.name, tracks: playlistTracks };
            }
          } catch (e) {
            console.warn(`Failed to load playlist ${p.name}:`, e);
          }
          return null;
        };
        
        // Run with concurrency limit
        const runWithConcurrency = async (items, fn, limit) => {
          const results = [];
          const executing = new Set();
          
          for (const item of items) {
            const promise = fn(item).then(result => {
              executing.delete(promise);
              completed++;
              updateLoadingProgress(`Loading playlists... ${completed}/${total}`);
              return result;
            });
            
            executing.add(promise);
            results.push(promise);
            
            if (executing.size >= limit) {
              await Promise.race(executing);
            }
          }
          
          return Promise.all(results);
        };
        
        updateLoadingProgress(`Loading playlists... 0/${total}`);
        const playlistResults = await runWithConcurrency(playlistsRaw, processPlaylist, CONCURRENCY);
        
        // Now merge all results into songs and playlists (single-threaded, no race conditions)
        const songs = {};
        const playlists = [];
        
        for (const result of playlistResults) {
          if (!result) continue;
          
          const songIds = [];
          for (const track of result.tracks) {
            songIds.push(track.id);
            
            if (!songs[track.id]) {
              songs[track.id] = {
                i: track.id,
                n: track.name,
                a: track.artist,
                img: track.img,
                c: classifyGenre(track.artist)
              };
            }
          }
          
          playlists.push({ i: result.id, n: result.name, s: songIds });
        }
        
        // Build MUSIC_DATA
        window.MUSIC_DATA = {
          songs: Object.values(songs),
          playlists: playlists
        };
        
        console.log(`Loaded ${MUSIC_DATA.songs.length} songs from ${MUSIC_DATA.playlists.length} playlists`);
        
        // Initialize visualization
        document.getElementById('loading').classList.remove('visible');
        init();
        
      } catch (error) {
        console.error('Error loading Spotify data:', error);
        document.getElementById('loading-text').textContent = 'Error loading data. Please try again.';
        document.getElementById('loading-progress').innerHTML = `<span style="color:#ff6b6b">${error.message}</span><br><br><a href="${window.location.pathname}" style="color:#4ecdc4">Retry</a>`;
      }
    }
    
    function logout() {
      localStorage.clear();
      window.location.href = window.location.pathname;
    }
    
    // ==================== VISUALIZATION ====================
    const categoryColors = {
      'r&b': '#f39c12', 'hip-hop': '#1abc9c', 'pop': '#ff6b81', 'rock': '#e74c3c',
      'electronic': '#00d2d3', 'soul': '#9b59b6', 'latin': '#fd79a8', 'indie': '#a29bfe',
      'jazz': '#fdcb6e', 'country': '#d35400', 'dancehall': '#00b894', 'other': '#636e72'
    };
    
    const playlistColorPalette = [
      '#ff6b6b', '#4ecdc4', '#ffe66d', '#95e1d3', '#dda0dd', '#f7dc6f',
      '#87ceeb', '#ff9f43', '#a29bfe', '#fd79a8', '#00cec9', '#e17055',
      '#74b9ff', '#55efc4', '#ffeaa7', '#fab1a0', '#81ecec', '#dfe6e9'
    ];
    
    const categoryOrder = ['r&b', 'soul', 'hip-hop', 'pop', 'rock', 'electronic', 'latin', 'indie', 'jazz', 'country', 'dancehall', 'other'];
    
    let zoom = 0.35, panX = 0, panY = 0, isPanning = false, panStartX = 0, panStartY = 0;
    let hoveredPlaylist = null, hoveredCategory = null, hoveredPlaylistIdx = -1;
    let playlistColors = {}, playlistColorIdx = {}, songPopularity = {}, sortedSongs = [], songElements = new Map();
    
    const catToClass = {
      'r&b': 'rb', 'hip-hop': 'hiphop', 'pop': 'pop', 'rock': 'rock',
      'electronic': 'electronic', 'soul': 'soul', 'latin': 'latin', 'indie': 'indie',
      'jazz': 'jazz', 'country': 'country', 'dancehall': 'dancehall', 'other': 'other'
    };
    
    let songToPlaylists = {};
    
    function generateSpiralPositions(count, gridSize) {
      const positions = [];
      const center = Math.floor(gridSize / 2);
      let x = center, y = center, dx = 0, dy = -1;
      for (let i = 0; i < gridSize * gridSize && positions.length < count; i++) {
        if (x >= 0 && x < gridSize && y >= 0 && y < gridSize) positions.push({ row: y, col: x });
        if (x === y || (x < center && x === -y + center * 2) || (x > center && x === -y + center * 2 + 1)) { const t = dx; dx = -dy; dy = t; }
        x += dx; y += dy;
      }
      return positions;
    }
    
    function analyzeTaste() {
      const playlists = MUSIC_DATA.playlists;
      const songs = MUSIC_DATA.songs;
      
      let totalPairs = 0, overlapSum = 0;
      
      for (let i = 0; i < playlists.length; i++) {
        for (let j = i + 1; j < playlists.length; j++) {
          const set1 = new Set(playlists[i].s);
          const set2 = new Set(playlists[j].s);
          const intersection = [...set1].filter(x => set2.has(x)).length;
          const minSize = Math.min(set1.size, set2.size);
          if (minSize > 0) {
            overlapSum += intersection / minSize;
            totalPairs++;
          }
        }
      }
      
      const avgOverlap = totalPairs > 0 ? overlapSum / totalPairs : 0;
      const multiPlaylistSongs = songs.filter(s => songPopularity[s.i] > 1).length;
      const genresUsed = new Set(songs.map(s => s.c)).size;
      const focusScore = Math.min(100, Math.max(0, Math.round(avgOverlap * 100 * 2.5)));
      
      let label, color;
      if (focusScore < 20) { label = "ü¶Ñ Wildly Eclectic"; color = "#a29bfe"; }
      else if (focusScore < 35) { label = "üé® Diverse Explorer"; color = "#74b9ff"; }
      else if (focusScore < 50) { label = "üéß Balanced Listener"; color = "#00cec9"; }
      else if (focusScore < 65) { label = "üéØ Curated Taste"; color = "#55efc4"; }
      else if (focusScore < 80) { label = "üíé Focused Collector"; color = "#ffeaa7"; }
      else { label = "üî• Ultra Cohesive"; color = "#ff6b6b"; }
      
      document.getElementById('taste-label').textContent = label;
      document.getElementById('taste-label').style.color = color;
      
      const bar = document.getElementById('taste-bar');
      bar.style.width = focusScore + '%';
      bar.style.background = `linear-gradient(90deg, #a29bfe, ${color})`;
      
      document.getElementById('taste-stats').innerHTML = `
        <div class="taste-stat"><div class="taste-stat-value" style="color:${color}">${focusScore}%</div><div class="taste-stat-label">Focus Score</div></div>
        <div class="taste-stat"><div class="taste-stat-value">${multiPlaylistSongs}</div><div class="taste-stat-label">Crossover Songs</div></div>
        <div class="taste-stat"><div class="taste-stat-value">${Math.round(avgOverlap * 100)}%</div><div class="taste-stat-label">Avg Overlap</div></div>
        <div class="taste-stat"><div class="taste-stat-value">${genresUsed}</div><div class="taste-stat-label">Genres</div></div>
      `;
    }
    
    function init() {
      console.log(`Initializing with ${MUSIC_DATA.songs.length} songs...`);
      
      // Update user info
      const userName = localStorage.getItem('user_name') || 'User';
      const userImage = localStorage.getItem('user_image');
      document.getElementById('user-name').textContent = userName;
      if (userImage) {
        document.getElementById('user-avatar').innerHTML = `<img src="${userImage}" alt="">`;
      } else {
        document.getElementById('user-avatar').textContent = userName[0].toUpperCase();
      }
      
      // Build indexes
      MUSIC_DATA.songs.forEach(s => { songPopularity[s.i] = 0; songToPlaylists[s.i] = []; });
      MUSIC_DATA.playlists.forEach((p, i) => { 
        playlistColors[p.i] = playlistColorPalette[i % playlistColorPalette.length];
        playlistColorIdx[p.i] = i % playlistColorPalette.length;
        p.s.forEach(songId => {
          if (songToPlaylists[songId] !== undefined) {
            songToPlaylists[songId].push(p.i);
            songPopularity[songId]++;
          }
        });
      });
      
      sortedSongs = [...MUSIC_DATA.songs].sort((a, b) => (songPopularity[b.i] - songPopularity[a.i]) || (categoryOrder.indexOf(a.c) - categoryOrder.indexOf(b.c)));
      
      // Adjust zoom based on song count
      if (sortedSongs.length > 2000) zoom = 0.3;
      else if (sortedSongs.length > 1000) zoom = 0.4;
      else if (sortedSongs.length > 500) zoom = 0.5;
      else zoom = 0.6;
      
      document.getElementById('song-count').textContent = MUSIC_DATA.songs.length;
      document.getElementById('playlist-count').textContent = MUSIC_DATA.playlists.length;
      
      renderGenres();
      renderPlaylists();
      renderGrid();
      analyzeTaste();
      setupEventListeners();
      
      document.getElementById('app').classList.add('ready');
    }
    
    function renderGenres() {
      const cats = {}; MUSIC_DATA.songs.forEach(s => { cats[s.c] = (cats[s.c] || 0) + 1; });
      const container = document.getElementById('genres');
      container.innerHTML = Object.entries(cats)
        .sort((a, b) => categoryOrder.indexOf(a[0]) - categoryOrder.indexOf(b[0]))
        .map(([c, n]) => `<div class="genre-item" data-category="${c}"><div class="genre-dot" style="background:${categoryColors[c]}"></div><span class="genre-name">${c}</span><span class="genre-count">${n}</span></div>`).join('');
      
      container.onmouseover = e => {
        const item = e.target.closest('.genre-item');
        if (item && hoveredCategory !== item.dataset.category) { hoveredCategory = item.dataset.category; updateHighlights(); }
      };
      container.onmouseleave = () => { hoveredCategory = null; updateHighlights(); };
    }
    
    function renderPlaylists() {
      const container = document.getElementById('playlists');
      container.innerHTML = MUSIC_DATA.playlists.map((p, i) => 
        `<div class="playlist-item" data-playlist="${p.i}" data-idx="${i % playlistColorPalette.length}"><div class="playlist-dot" style="background:${playlistColors[p.i]}"></div><div class="playlist-info"><div class="playlist-name">${p.n}</div><div class="playlist-count">${p.s.length} songs</div></div></div>`
      ).join('');
      
      container.onmouseover = e => {
        const item = e.target.closest('.playlist-item');
        if (item && hoveredPlaylist !== item.dataset.playlist) { hoveredPlaylist = item.dataset.playlist; updateHighlights(); }
      };
      container.onmouseleave = () => { hoveredPlaylist = null; updateHighlights(); };
    }
    
    function renderGrid() {
      const gridSize = Math.ceil(Math.sqrt(sortedSongs.length));
      const positions = generateSpiralPositions(sortedSongs.length, gridSize);
      const grid = document.getElementById('grid');
      grid.style.gridTemplateColumns = `repeat(${gridSize}, 52px)`;
      grid.style.gridTemplateRows = `repeat(${gridSize}, 52px)`;
      
      const fragment = document.createDocumentFragment();
      sortedSongs.forEach((song, idx) => {
        const pos = positions[idx]; if (!pos) return;
        const tile = document.createElement('div');
        tile.className = 'song-tile';
        tile.dataset.song = song.i;
        tile.dataset.category = song.c;
        tile.style.cssText = `grid-row:${pos.row+1};grid-column:${pos.col+1};background:${categoryColors[song.c]}`;
        tile.innerHTML = `<img src="${song.img}" alt="" loading="lazy" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'"><div class="fallback" style="display:none;background:${categoryColors[song.c]}">${song.n.split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase()}</div><div class="category-bar" style="background:${categoryColors[song.c]}"></div>${songPopularity[song.i]>1?`<div class="popularity-badge">${songPopularity[song.i]}</div>`:''}`;
        tile.onmouseenter = e => showTooltip(e, song.i);
        tile.onmouseleave = hideTooltip;
        tile.onmousemove = moveTooltip;
        fragment.appendChild(tile);
        songElements.set(song.i, tile);
      });
      grid.appendChild(fragment);
      updateTransform();
    }
    
    function updateHighlights() {
      const shouldDim = hoveredPlaylist || hoveredCategory;
      let highlightedSongs, hlClass = '';
      
      if (hoveredPlaylist) {
        const playlist = MUSIC_DATA.playlists.find(p => p.i === hoveredPlaylist);
        highlightedSongs = playlist ? new Set(playlist.s) : new Set();
        hlClass = 'hl-' + playlistColorIdx[hoveredPlaylist];
      } else if (hoveredCategory) {
        highlightedSongs = new Set();
        MUSIC_DATA.songs.forEach(s => { if (s.c === hoveredCategory) highlightedSongs.add(s.i); });
        hlClass = 'hl-cat-' + catToClass[hoveredCategory];
      } else {
        highlightedSongs = new Set();
      }
      
      requestAnimationFrame(() => {
        songElements.forEach((el, songId) => {
          const isHighlighted = highlightedSongs.has(songId);
          el.className = 'song-tile' + (shouldDim && !isHighlighted ? ' dimmed' : '') + (isHighlighted ? ' highlighted ' + hlClass : '');
        });
      });
    }
    
    function showTooltip(e, songId) {
      const song = MUSIC_DATA.songs.find(s => s.i === songId); if (!song) return;
      const playlistIds = songToPlaylists[songId] || [];
      const pls = playlistIds.map(pid => MUSIC_DATA.playlists.find(p => p.i === pid)).filter(Boolean);
      document.getElementById('tooltip-song').textContent = song.n;
      document.getElementById('tooltip-artist').textContent = song.a;
      const cb = document.getElementById('tooltip-category');
      cb.textContent = song.c; cb.style.background = categoryColors[song.c]+'35'; cb.style.color = categoryColors[song.c];
      document.getElementById('tooltip-playlists').innerHTML = pls.slice(0,5).map(p => `<span class="playlist-tag" style="background:${playlistColors[p.i]}25;color:${playlistColors[p.i]}">${p.n.length>16?p.n.slice(0,16)+'...':p.n}</span>`).join('');
      document.getElementById('tooltip').classList.add('visible');
      moveTooltip(e);
    }
    
    function moveTooltip(e) {
      const t = document.getElementById('tooltip'), r = t.getBoundingClientRect();
      t.style.left = Math.min(e.clientX+15, innerWidth-r.width-10)+'px';
      t.style.top = Math.max(10, Math.min(e.clientY-10, innerHeight-r.height-10))+'px';
    }
    
    function hideTooltip() { document.getElementById('tooltip').classList.remove('visible'); }
    function updateTransform() {
      document.getElementById('grid-container').style.transform = `translate(calc(-50% + ${panX}px), calc(-50% + ${panY}px)) scale(${zoom})`;
      document.getElementById('zoom-level').textContent = Math.round(zoom * 100);
    }
    function adjustZoom(d) { zoom = Math.max(0.1, Math.min(2, zoom + d)); updateTransform(); }
    function resetZoom() { zoom = 0.35; panX = 0; panY = 0; updateTransform(); }
    
    function setupEventListeners() {
      const app = document.getElementById('app');
      app.onmousedown = e => {
        if (e.target.closest('.control-panel,.song-tile')) return;
        isPanning = true; panStartX = e.clientX - panX; panStartY = e.clientY - panY; app.classList.add('panning');
      };
      onmousemove = e => { if (isPanning) { panX = e.clientX - panStartX; panY = e.clientY - panStartY; updateTransform(); } };
      onmouseup = () => { isPanning = false; app.classList.remove('panning'); };
      app.onwheel = e => { if (!e.target.closest('.control-panel')) { e.preventDefault(); adjustZoom(e.deltaY > 0 ? -0.05 : 0.05); } };
      
      let st; document.getElementById('search').oninput = e => {
        clearTimeout(st); st = setTimeout(() => {
          const q = e.target.value.toLowerCase().trim(), res = document.getElementById('search-results');
          if (!q) { res.innerHTML = ''; return; }
          const m = MUSIC_DATA.songs.filter(s => s.n.toLowerCase().includes(q) || s.a.toLowerCase().includes(q)).slice(0,12);
          res.innerHTML = m.map(s => `<div class="search-result" data-song="${s.i}"><div>${s.n}</div><div class="artist">${s.a}</div></div>`).join('');
          res.querySelectorAll('.search-result').forEach(el => {
            el.onclick = () => { const t = songElements.get(el.dataset.song); if(t){ t.scrollIntoView({behavior:'smooth',block:'center'}); t.style.boxShadow='0 0 30px #fff'; setTimeout(()=>t.style.boxShadow='',1500); } };
          });
        }, 150);
      };
      
      document.getElementById('logout-btn').onclick = logout;
    }
    
    // ==================== INITIALIZATION ====================
    (async function() {
      // Check for callback code in URL
      const urlParams = new URLSearchParams(window.location.search);
      const code = urlParams.get('code');
      
      if (code) {
        // Clear URL params
        window.history.replaceState({}, document.title, window.location.pathname);
        
        // Exchange code for token
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('loading').classList.add('visible');
        document.getElementById('loading-text').textContent = 'Connecting to Spotify...';
        
        try {
          const token = await getToken(code);
          if (token) {
            await loadSpotifyData(token);
          } else {
            throw new Error('Failed to get access token');
          }
        } catch (e) {
          console.error(e);
          localStorage.clear();
          document.getElementById('loading-text').textContent = 'Authentication failed';
          document.getElementById('loading-progress').innerHTML = `<a href="${window.location.pathname}" style="color:#4ecdc4">Try again</a>`;
        }
        return;
      }
      
      // Check for existing valid token
      const token = localStorage.getItem('access_token');
      const expiry = localStorage.getItem('token_expiry');
      
      if (token && expiry && Date.now() < parseInt(expiry)) {
        await loadSpotifyData(token);
        return;
      }
      
      // Show login screen
      document.getElementById('login-btn').onclick = startAuth;
    })();
  </script>
</body>
</html>
