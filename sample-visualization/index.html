<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Common Ground - Music Visualization</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { 
      font-family: 'Inter', -apple-system, sans-serif;
      background: linear-gradient(145deg, #0d0d12 0%, #1a1a2e 40%, #16213e 100%);
      min-height: 100vh;
      overflow: hidden;
      color: #fff;
    }
    
    #loading {
      position: fixed;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: linear-gradient(145deg, #0d0d12 0%, #1a1a2e 40%, #16213e 100%);
      z-index: 9999;
    }
    
    #loading.hidden { display: none; }
    
    .loader {
      width: 50px;
      height: 50px;
      border: 3px solid rgba(255,255,255,0.1);
      border-top-color: #4ecdc4;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 16px;
    }
    
    @keyframes spin { to { transform: rotate(360deg); } }
    
    #loading p { color: rgba(255,255,255,0.6); font-size: 15px; }
    
    #error {
      position: fixed;
      inset: 0;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: linear-gradient(145deg, #0d0d12 0%, #1a1a2e 40%, #16213e 100%);
      z-index: 9999;
      padding: 20px;
      text-align: center;
    }
    
    #error.visible { display: flex; }
    #error h2 { color: #ff6b6b; margin-bottom: 12px; }
    #error p { color: rgba(255,255,255,0.6); max-width: 500px; line-height: 1.6; }
    #error code { background: rgba(255,255,255,0.1); padding: 2px 8px; border-radius: 4px; font-size: 14px; }
    
    #app {
      width: 100vw;
      height: 100vh;
      position: relative;
      cursor: grab;
      display: none;
    }
    
    #app.ready { display: block; }
    #app.panning { cursor: grabbing; }
    
    .control-panel {
      position: fixed;
      top: 16px;
      left: 16px;
      background: rgba(12,12,20,0.92);
      backdrop-filter: blur(20px);
      border-radius: 16px;
      padding: 18px;
      z-index: 1000;
      border: 1px solid rgba(255,255,255,0.08);
      min-width: 260px;
      max-width: 280px;
      max-height: calc(100vh - 32px);
      overflow-y: auto;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
      cursor: default;
    }
    
    .control-panel h1 { font-size: 20px; font-weight: 700; margin-bottom: 2px; letter-spacing: -0.3px; }
    .control-panel .subtitle { color: rgba(255,255,255,0.45); font-size: 12px; margin-bottom: 14px; }
    
    .search-input {
      width: 100%;
      padding: 9px 12px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.1);
      background: rgba(255,255,255,0.04);
      color: #fff;
      font-size: 13px;
      margin-bottom: 10px;
      outline: none;
      font-family: inherit;
    }
    
    .search-input:focus { border-color: rgba(255,255,255,0.2); background: rgba(255,255,255,0.06); }
    .search-results { max-height: 120px; overflow-y: auto; margin-bottom: 14px; }
    
    .search-result {
      padding: 5px 8px;
      font-size: 12px;
      color: rgba(255,255,255,0.8);
      border-radius: 6px;
      background: rgba(255,255,255,0.04);
      margin-bottom: 3px;
      cursor: pointer;
      transition: background 0.15s;
    }
    
    .search-result:hover { background: rgba(255,255,255,0.08); }
    .search-result .artist { color: rgba(255,255,255,0.4); font-size: 11px; }
    
    .section-title { font-size: 11px; color: rgba(255,255,255,0.35); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }
    .zoom-controls { display: flex; gap: 6px; margin-bottom: 5px; }
    
    .zoom-btn {
      flex: 1; padding: 7px; border-radius: 6px; border: none;
      background: rgba(255,255,255,0.08); color: #fff; cursor: pointer;
      font-size: 13px; font-weight: 500; font-family: inherit; transition: background 0.15s;
    }
    
    .zoom-btn:hover { background: rgba(255,255,255,0.12); }
    .zoom-hint { font-size: 10px; color: rgba(255,255,255,0.25); text-align: center; margin-bottom: 14px; }
    .genres-grid { display: flex; flex-wrap: wrap; gap: 3px; margin-bottom: 14px; }
    
    .genre-item {
      display: flex; align-items: center; gap: 5px; padding: 4px 7px;
      border-radius: 8px; cursor: pointer; transition: all 0.15s; border: 1px solid transparent;
    }
    
    .genre-item:hover { background: rgba(255,255,255,0.08); }
    .genre-dot { width: 8px; height: 8px; border-radius: 2px; }
    .genre-name { font-size: 11px; text-transform: capitalize; }
    .genre-count { font-size: 10px; color: rgba(255,255,255,0.35); }
    .playlists-list { max-height: 220px; overflow-y: auto; }
    
    .playlist-item {
      display: flex; align-items: center; gap: 8px; padding: 6px 8px;
      border-radius: 8px; cursor: pointer; transition: all 0.15s;
    }
    
    .playlist-item:hover { background: rgba(255,255,255,0.08); }
    .playlist-dot { width: 8px; height: 8px; border-radius: 2px; flex-shrink: 0; }
    .playlist-info { flex: 1; min-width: 0; }
    .playlist-name { font-size: 12px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .playlist-count { font-size: 10px; color: rgba(255,255,255,0.35); }
    
    #grid-container { position: absolute; left: 50%; top: 50%; transform-origin: center center; }
    #grid { display: grid; gap: 5px; }
    
    .song-tile {
      width: 52px; height: 52px; border-radius: 6px; position: relative; overflow: hidden;
      cursor: pointer; transition: all 0.15s ease; border: 2px solid transparent;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    
    .song-tile:hover { transform: scale(1.3); z-index: 100; box-shadow: 0 8px 32px rgba(0,0,0,0.5); }
    .song-tile.dimmed { opacity: 0.1; }
    .song-tile.highlighted { box-shadow: 0 0 16px var(--highlight-color); }
    .song-tile img { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; }
    
    .song-tile .fallback {
      display: flex; align-items: center; justify-content: center;
      width: 100%; height: 100%; font-size: 13px; font-weight: 600; color: rgba(255,255,255,0.85);
    }
    
    .song-tile .category-bar { position: absolute; bottom: 0; left: 0; right: 0; height: 3px; }
    
    .song-tile .popularity-badge {
      position: absolute; top: 2px; right: 2px; background: rgba(0,0,0,0.8);
      border-radius: 8px; padding: 1px 4px; font-size: 9px; font-weight: 600;
    }
    
    .tooltip {
      position: fixed; background: rgba(8,8,16,0.97); border: 1px solid rgba(255,255,255,0.12);
      border-radius: 12px; padding: 12px 16px; z-index: 2000; min-width: 180px; max-width: 260px;
      pointer-events: none; box-shadow: 0 12px 40px rgba(0,0,0,0.5); display: none;
    }
    
    .tooltip.visible { display: block; }
    .tooltip .song-name { font-weight: 600; font-size: 14px; margin-bottom: 3px; }
    .tooltip .artist-name { color: rgba(255,255,255,0.55); font-size: 12px; margin-bottom: 8px; }
    
    .tooltip .category-badge {
      display: inline-block; font-size: 10px; padding: 3px 8px; border-radius: 12px;
      font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;
    }
    
    .tooltip .playlist-tags { display: flex; gap: 4px; flex-wrap: wrap; }
    .tooltip .playlist-tag { font-size: 10px; padding: 3px 7px; border-radius: 10px; font-weight: 500; }
    
    .instructions {
      position: fixed; bottom: 16px; right: 16px; background: rgba(12,12,20,0.85);
      backdrop-filter: blur(10px); border-radius: 10px; padding: 10px 14px;
      border: 1px solid rgba(255,255,255,0.08); font-size: 11px; color: rgba(255,255,255,0.5);
    }
    
    .instructions strong { color: rgba(255,255,255,0.7); }
    
    .taste-profile { margin-bottom: 16px; }
    .taste-score-container { margin-bottom: 10px; }
    .taste-label { font-size: 15px; font-weight: 600; margin-bottom: 6px; text-align: center; }
    .taste-bar-bg { height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden; margin-bottom: 4px; }
    .taste-bar { height: 100%; border-radius: 4px; transition: width 1s ease, background 1s ease; }
    .taste-spectrum { display: flex; justify-content: space-between; font-size: 10px; color: rgba(255,255,255,0.4); }
    .taste-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-top: 10px; }
    .taste-stat { background: rgba(255,255,255,0.04); border-radius: 8px; padding: 8px; text-align: center; }
    .taste-stat-value { font-size: 18px; font-weight: 700; margin-bottom: 2px; }
    .taste-stat-label { font-size: 10px; color: rgba(255,255,255,0.5); text-transform: uppercase; letter-spacing: 0.5px; }
    
    ::-webkit-scrollbar { width: 5px; }
    ::-webkit-scrollbar-track { background: rgba(255,255,255,0.03); }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 3px; }
  </style>
</head>
<body>
  <div id="loading">
    <div class="loader"></div>
    <p>Loading your music library...</p>
  </div>
  
  <div id="error">
    <h2>‚ö†Ô∏è Data File Not Found</h2>
    <p>
      Make sure <code>music-data-full.js</code> is in the same folder as this HTML file.
      <br><br>
      Both files should be together:<br>
      üìÅ your-folder/<br>
      &nbsp;&nbsp;&nbsp;‚îú‚îÄ‚îÄ playlist-visualization.html<br>
      &nbsp;&nbsp;&nbsp;‚îî‚îÄ‚îÄ music-data-full.js
    </p>
  </div>
  
  <div id="app">
    <div class="control-panel">
      <h1>üéµ Common Ground</h1>
      <p class="subtitle"><span id="song-count">0</span> songs ‚Ä¢ <span id="playlist-count">0</span> playlists</p>
      
      <input type="text" class="search-input" id="search" placeholder="Search songs or artists...">
      <div class="search-results" id="search-results"></div>
      
      <div class="section-title">Zoom: <span id="zoom-level">35</span>%</div>
      <div class="zoom-controls">
        <button class="zoom-btn" onclick="adjustZoom(-0.1)">‚àí</button>
        <button class="zoom-btn" onclick="resetZoom()">Reset</button>
        <button class="zoom-btn" onclick="adjustZoom(0.1)">+</button>
      </div>
      <div class="zoom-hint">Scroll to zoom ‚Ä¢ Drag to pan</div>
      
      <div class="section-title">Your Taste Profile</div>
      <div class="taste-profile" id="taste-profile">
        <div class="taste-score-container">
          <div class="taste-label" id="taste-label">Analyzing...</div>
          <div class="taste-bar-bg">
            <div class="taste-bar" id="taste-bar"></div>
          </div>
          <div class="taste-spectrum">
            <span>Eclectic</span>
            <span>Focused</span>
          </div>
        </div>
        <div class="taste-stats" id="taste-stats"></div>
      </div>
      
      <div class="section-title">Genres</div>
      <div class="genres-grid" id="genres"></div>
      
      <div class="section-title">Playlists</div>
      <div class="playlists-list" id="playlists"></div>
    </div>
    
    <div id="grid-container"><div id="grid"></div></div>
    
    <div class="tooltip" id="tooltip">
      <div class="song-name" id="tooltip-song"></div>
      <div class="artist-name" id="tooltip-artist"></div>
      <div class="category-badge" id="tooltip-category"></div>
      <div class="playlist-tags" id="tooltip-playlists"></div>
    </div>
    
    <div class="instructions">
      <div>üîç <strong>Hover</strong> playlists/genres to highlight</div>
      <div>üìç Most popular songs are in the <strong>center</strong></div>
    </div>
  </div>

  <!-- Load external data file - must be in same folder -->
  <script src="music-data-full.js"></script>
  
  <script>
    // Check if data loaded
    if (typeof MUSIC_DATA === 'undefined') {
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('error').classList.add('visible');
      throw new Error('MUSIC_DATA not loaded');
    }
    
    const categoryColors = {
      'r&b': '#f39c12', 'hip-hop': '#1abc9c', 'pop': '#ff6b81', 'rock': '#e74c3c',
      'electronic': '#00d2d3', 'soul': '#9b59b6', 'latin': '#fd79a8', 'indie': '#a29bfe',
      'jazz': '#fdcb6e', 'country': '#d35400', 'dancehall': '#00b894', 'other': '#636e72'
    };
    
    const playlistColorPalette = [
      '#ff6b6b', '#4ecdc4', '#ffe66d', '#95e1d3', '#dda0dd', '#f7dc6f',
      '#87ceeb', '#ff9f43', '#a29bfe', '#fd79a8', '#00cec9', '#e17055',
      '#74b9ff', '#55efc4', '#ffeaa7', '#fab1a0', '#81ecec', '#dfe6e9'
    ];
    
    const categoryOrder = ['r&b', 'soul', 'hip-hop', 'pop', 'rock', 'electronic', 'latin', 'indie', 'jazz', 'country', 'dancehall', 'other'];
    
    let zoom = 0.35, panX = 0, panY = 0, isPanning = false, panStartX = 0, panStartY = 0;
    let hoveredPlaylist = null, hoveredCategory = null;
    let playlistColors = {}, songPopularity = {}, sortedSongs = [], songElements = new Map();
    
    function generateSpiralPositions(count, gridSize) {
      const positions = [];
      const center = Math.floor(gridSize / 2);
      let x = center, y = center, dx = 0, dy = -1;
      for (let i = 0; i < gridSize * gridSize && positions.length < count; i++) {
        if (x >= 0 && x < gridSize && y >= 0 && y < gridSize) positions.push({ row: y, col: x });
        if (x === y || (x < center && x === -y + center * 2) || (x > center && x === -y + center * 2 + 1)) { const t = dx; dx = -dy; dy = t; }
        x += dx; y += dy;
      }
      return positions;
    }
    
    function analyzeTaste() {
      const playlists = MUSIC_DATA.playlists;
      const songs = MUSIC_DATA.songs;
      
      // Calculate overlap metrics
      let totalPairs = 0;
      let overlapSum = 0;
      let maxOverlap = 0;
      
      // Compare each pair of playlists
      for (let i = 0; i < playlists.length; i++) {
        for (let j = i + 1; j < playlists.length; j++) {
          const set1 = new Set(playlists[i].s);
          const set2 = new Set(playlists[j].s);
          const intersection = [...set1].filter(x => set2.has(x)).length;
          const minSize = Math.min(set1.size, set2.size);
          
          if (minSize > 0) {
            const overlapRatio = intersection / minSize;
            overlapSum += overlapRatio;
            maxOverlap = Math.max(maxOverlap, overlapRatio);
            totalPairs++;
          }
        }
      }
      
      const avgOverlap = totalPairs > 0 ? overlapSum / totalPairs : 0;
      
      // Count songs appearing in multiple playlists
      const multiPlaylistSongs = songs.filter(s => songPopularity[s.i] > 1).length;
      const multiPlaylistPct = (multiPlaylistSongs / songs.length * 100);
      
      // Count unique genres used
      const genresUsed = new Set(songs.map(s => s.c)).size;
      
      // Calculate "focus score" (0-100)
      // Higher = more overlap = more focused/cohesive taste
      // Lower = less overlap = more eclectic/diverse taste
      const focusScore = Math.round(avgOverlap * 100 * 2.5); // Scale up since overlaps tend to be low
      const clampedScore = Math.min(100, Math.max(0, focusScore));
      
      // Determine label based on score
      let label, color;
      if (clampedScore < 20) {
        label = "ü¶Ñ Wildly Eclectic";
        color = "#a29bfe";
      } else if (clampedScore < 35) {
        label = "üé® Diverse Explorer";
        color = "#74b9ff";
      } else if (clampedScore < 50) {
        label = "üéß Balanced Listener";
        color = "#00cec9";
      } else if (clampedScore < 65) {
        label = "üéØ Curated Taste";
        color = "#55efc4";
      } else if (clampedScore < 80) {
        label = "üíé Focused Collector";
        color = "#ffeaa7";
      } else {
        label = "üî• Ultra Cohesive";
        color = "#ff6b6b";
      }
      
      // Update UI
      document.getElementById('taste-label').textContent = label;
      document.getElementById('taste-label').style.color = color;
      
      const bar = document.getElementById('taste-bar');
      bar.style.width = clampedScore + '%';
      bar.style.background = `linear-gradient(90deg, #a29bfe, ${color})`;
      
      document.getElementById('taste-stats').innerHTML = `
        <div class="taste-stat">
          <div class="taste-stat-value" style="color: ${color}">${clampedScore}%</div>
          <div class="taste-stat-label">Focus Score</div>
        </div>
        <div class="taste-stat">
          <div class="taste-stat-value">${multiPlaylistSongs}</div>
          <div class="taste-stat-label">Crossover Songs</div>
        </div>
        <div class="taste-stat">
          <div class="taste-stat-value">${Math.round(avgOverlap * 100)}%</div>
          <div class="taste-stat-label">Avg Overlap</div>
        </div>
        <div class="taste-stat">
          <div class="taste-stat-value">${genresUsed}</div>
          <div class="taste-stat-label">Genres</div>
        </div>
      `;
    }
    
    function init() {
      console.log(`Loading ${MUSIC_DATA.songs.length} songs...`);
      
      MUSIC_DATA.songs.forEach(s => { songPopularity[s.i] = MUSIC_DATA.playlists.filter(p => p.s.includes(s.i)).length; });
      sortedSongs = [...MUSIC_DATA.songs].sort((a, b) => (songPopularity[b.i] - songPopularity[a.i]) || (categoryOrder.indexOf(a.c) - categoryOrder.indexOf(b.c)));
      MUSIC_DATA.playlists.forEach((p, i) => { playlistColors[p.i] = playlistColorPalette[i % playlistColorPalette.length]; });
      
      document.getElementById('song-count').textContent = MUSIC_DATA.songs.length;
      document.getElementById('playlist-count').textContent = MUSIC_DATA.playlists.length;
      
      renderGenres(); renderPlaylists(); renderGrid(); analyzeTaste(); setupEventListeners();
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('app').classList.add('ready');
    }
    
    function renderGenres() {
      const cats = {}; MUSIC_DATA.songs.forEach(s => { cats[s.c] = (cats[s.c] || 0) + 1; });
      document.getElementById('genres').innerHTML = Object.entries(cats)
        .sort((a, b) => categoryOrder.indexOf(a[0]) - categoryOrder.indexOf(b[0]))
        .map(([c, n]) => `<div class="genre-item" data-category="${c}"><div class="genre-dot" style="background:${categoryColors[c]}"></div><span class="genre-name">${c}</span><span class="genre-count">${n}</span></div>`).join('');
      document.querySelectorAll('.genre-item').forEach(el => {
        el.onmouseenter = () => { hoveredCategory = el.dataset.category; updateHighlights(); };
        el.onmouseleave = () => { hoveredCategory = null; updateHighlights(); };
      });
    }
    
    function renderPlaylists() {
      document.getElementById('playlists').innerHTML = MUSIC_DATA.playlists.map(p => 
        `<div class="playlist-item" data-playlist="${p.i}"><div class="playlist-dot" style="background:${playlistColors[p.i]}"></div><div class="playlist-info"><div class="playlist-name">${p.n}</div><div class="playlist-count">${p.s.length} songs</div></div></div>`
      ).join('');
      document.querySelectorAll('.playlist-item').forEach(el => {
        el.onmouseenter = () => { hoveredPlaylist = el.dataset.playlist; updateHighlights(); };
        el.onmouseleave = () => { hoveredPlaylist = null; updateHighlights(); };
      });
    }
    
    function renderGrid() {
      const gridSize = Math.ceil(Math.sqrt(sortedSongs.length));
      const positions = generateSpiralPositions(sortedSongs.length, gridSize);
      const grid = document.getElementById('grid');
      grid.style.gridTemplateColumns = `repeat(${gridSize}, 52px)`;
      grid.style.gridTemplateRows = `repeat(${gridSize}, 52px)`;
      
      const fragment = document.createDocumentFragment();
      sortedSongs.forEach((song, idx) => {
        const pos = positions[idx]; if (!pos) return;
        const tile = document.createElement('div');
        tile.className = 'song-tile';
        tile.dataset.song = song.i;
        tile.dataset.category = song.c;
        tile.style.cssText = `grid-row:${pos.row+1};grid-column:${pos.col+1};background:${categoryColors[song.c]}`;
        tile.innerHTML = `<img src="${song.img}" alt="" loading="lazy" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'"><div class="fallback" style="display:none;background:${categoryColors[song.c]}">${song.n.split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase()}</div><div class="category-bar" style="background:${categoryColors[song.c]}"></div>${songPopularity[song.i]>1?`<div class="popularity-badge">${songPopularity[song.i]}</div>`:''}`;
        tile.onmouseenter = e => showTooltip(e, song.i);
        tile.onmouseleave = hideTooltip;
        tile.onmousemove = moveTooltip;
        fragment.appendChild(tile);
        songElements.set(song.i, tile);
      });
      grid.appendChild(fragment);
      updateTransform();
    }
    
    function updateHighlights() {
      const highlighted = new Set();
      let color = null;
      if (hoveredPlaylist) {
        const p = MUSIC_DATA.playlists.find(x => x.i === hoveredPlaylist);
        if (p) p.s.forEach(id => highlighted.add(id));
        color = playlistColors[hoveredPlaylist];
      } else if (hoveredCategory) {
        MUSIC_DATA.songs.filter(s => s.c === hoveredCategory).forEach(s => highlighted.add(s.i));
        color = categoryColors[hoveredCategory];
      }
      const dim = hoveredPlaylist || hoveredCategory;
      songElements.forEach((el, id) => {
        const hl = highlighted.has(id);
        el.classList.toggle('dimmed', dim && !hl);
        el.classList.toggle('highlighted', hl);
        el.style.borderColor = hl && color ? color : 'transparent';
        if (hl && color) el.style.setProperty('--highlight-color', color + '70');
      });
    }
    
    function showTooltip(e, songId) {
      const song = MUSIC_DATA.songs.find(s => s.i === songId); if (!song) return;
      const pls = MUSIC_DATA.playlists.filter(p => p.s.includes(songId));
      document.getElementById('tooltip-song').textContent = song.n;
      document.getElementById('tooltip-artist').textContent = song.a;
      const cb = document.getElementById('tooltip-category');
      cb.textContent = song.c; cb.style.background = categoryColors[song.c]+'35'; cb.style.color = categoryColors[song.c];
      document.getElementById('tooltip-playlists').innerHTML = pls.slice(0,5).map(p => `<span class="playlist-tag" style="background:${playlistColors[p.i]}25;color:${playlistColors[p.i]}">${p.n.length>16?p.n.slice(0,16)+'...':p.n}</span>`).join('');
      document.getElementById('tooltip').classList.add('visible');
      moveTooltip(e);
    }
    
    function moveTooltip(e) {
      const t = document.getElementById('tooltip'), r = t.getBoundingClientRect();
      t.style.left = Math.min(e.clientX+15, innerWidth-r.width-10)+'px';
      t.style.top = Math.max(10, Math.min(e.clientY-10, innerHeight-r.height-10))+'px';
    }
    
    function hideTooltip() { document.getElementById('tooltip').classList.remove('visible'); }
    function updateTransform() {
      document.getElementById('grid-container').style.transform = `translate(calc(-50% + ${panX}px), calc(-50% + ${panY}px)) scale(${zoom})`;
      document.getElementById('zoom-level').textContent = Math.round(zoom * 100);
    }
    function adjustZoom(d) { zoom = Math.max(0.1, Math.min(2, zoom + d)); updateTransform(); }
    function resetZoom() { zoom = 0.35; panX = 0; panY = 0; updateTransform(); }
    
    function setupEventListeners() {
      const app = document.getElementById('app');
      app.onmousedown = e => {
        if (e.target.closest('.control-panel,.song-tile')) return;
        isPanning = true; panStartX = e.clientX - panX; panStartY = e.clientY - panY; app.classList.add('panning');
      };
      onmousemove = e => { if (isPanning) { panX = e.clientX - panStartX; panY = e.clientY - panStartY; updateTransform(); } };
      onmouseup = () => { isPanning = false; app.classList.remove('panning'); };
      app.onwheel = e => { if (!e.target.closest('.control-panel')) { e.preventDefault(); adjustZoom(e.deltaY > 0 ? -0.05 : 0.05); } };
      
      let st; document.getElementById('search').oninput = e => {
        clearTimeout(st); st = setTimeout(() => {
          const q = e.target.value.toLowerCase().trim(), res = document.getElementById('search-results');
          if (!q) { res.innerHTML = ''; return; }
          const m = MUSIC_DATA.songs.filter(s => s.n.toLowerCase().includes(q) || s.a.toLowerCase().includes(q)).slice(0,12);
          res.innerHTML = m.map(s => `<div class="search-result" data-song="${s.i}"><div>${s.n}</div><div class="artist">${s.a}</div></div>`).join('');
          res.querySelectorAll('.search-result').forEach(el => {
            el.onclick = () => { const t = songElements.get(el.dataset.song); if(t){ t.scrollIntoView({behavior:'smooth',block:'center'}); t.style.boxShadow='0 0 30px #fff'; setTimeout(()=>t.style.boxShadow='',1500); } };
          });
        }, 150);
      };
    }
    
    init();
  </script>
</body>
</html>
